
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the TripMind application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "displayName": {
          "type": "string",
          "description": "User's display name or username."
        },
        "profilePicture": {
          "type": "string",
          "description": "URL to the user's profile picture.",
          "format": "uri"
        },
        "preferences": {
          "type": "string",
          "description": "User's travel preferences serialized as JSON string."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName",
        "displayName"
      ]
    },
    "Trip": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Trip",
      "type": "object",
      "description": "Represents a travel trip planned by the user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Trip entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Trip)"
        },
        "destination": {
          "type": "string",
          "description": "Destination of the trip."
        },
        "startDate": {
          "type": "string",
          "description": "Start date of the trip.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "End date of the trip.",
          "format": "date-time"
        },
        "budget": {
          "type": "number",
          "description": "Budget for the trip."
        },
        "itinerary": {
          "type": "string",
          "description": "Trip itinerary serialized as JSON string."
        },
        "status": {
          "type": "string",
          "enum": [
            "Pending",
            "Booked"
          ],
          "description": "Booking status of the trip."
        }
      },
      "required": [
        "id",
        "userId",
        "destination",
        "startDate",
        "endDate",
        "budget"
      ]
    },
    "Expense": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Expense",
      "type": "object",
      "description": "Represents an expense incurred during a trip.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Expense entity."
        },
        "tripId": {
          "type": "string",
          "description": "Reference to Trip. (Relationship: Trip 1:N Expense)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Expense)"
        },
        "description": {
          "type": "string",
          "description": "Description of the expense."
        },
        "amount": {
          "type": "number",
          "description": "Amount of the expense."
        },
        "date": {
          "type": "string",
          "description": "Date of the expense.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "tripId",
        "userId",
        "description",
        "amount",
        "date"
      ]
    },
    "LocalBusiness": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LocalBusiness",
      "type": "object",
      "description": "Represents a local business or artisan.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the LocalBusiness entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the local business."
        },
        "description": {
          "type": "string",
          "description": "Description of the local business."
        },
        "address": {
          "type": "string",
          "description": "Address of the local business."
        },
        "contact": {
          "type": "string",
          "description": "Contact information for the local business."
        },
        "latitude": {
          "type": "number",
          "description": "Latitude of the local business."
        },
        "longitude": {
          "type": "number",
          "description": "Longitude of the local business."
        },
        "category": {
          "type": "string",
          "description": "Category of the local business."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "address"
      ]
    },
    "ItineraryItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ItineraryItem",
      "type": "object",
      "description": "Represents an item in a trip itinerary.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ItineraryItem entity."
        },
        "tripId": {
          "type": "string",
          "description": "Reference to Trip. (Relationship: Trip 1:N ItineraryItem)"
        },
        "localBusinessId": {
          "type": "string",
          "description": "Reference to LocalBusiness. (Relationship: LocalBusiness 1:N ItineraryItem)"
        },
        "description": {
          "type": "string",
          "description": "Description of the itinerary item."
        },
        "startTime": {
          "type": "string",
          "description": "Start time of the itinerary item.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "End time of the itinerary item.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "tripId",
        "description",
        "startTime",
        "endTime"
      ]
    },
    "AppStats": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AppStats",
      "type": "object",
      "description": "Represents live application statistics.",
      "properties": {
        "routesPlanned": {
          "type": "number",
          "description": "Total number of routes planned."
        },
        "happyTravelers": {
          "type": "number",
          "description": "Total number of happy travelers."
        },
        "destinations": {
          "type": "number",
          "description": "Total number of destinations available."
        }
      },
      "required": [
        "routesPlanned",
        "happyTravelers",
        "destinations"
      ]
    },
    "LocalSupporter": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LocalSupporter",
      "type": "object",
      "description": "Represents a local resident who can offer support to travelers.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the LocalSupporter entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the local supporter."
        },
        "bio": {
          "type": "string",
          "description": "A short bio about the supporter."
        },
        "location": {
          "type": "string",
          "description": "The city or area where the supporter is based."
        },
        "languages": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Languages spoken by the supporter."
        },
        "avatarUrl": {
          "type": "string",
          "format": "uri",
          "description": "URL to the supporter's profile picture."
        },
        "services": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": { "type": "string" },
                    "description": { "type": "string" },
                    "icon": { "type": "string", "enum": ["Car", "Coffee"] }
                },
                "required": ["name", "description", "icon"]
            }
        },
        "availability": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "day": { "type": "string" },
              "time": { "type": "string" },
              "booked": { "type": "boolean" }
            },
            "required": ["day", "time", "booked"]
          },
          "description": "Weekly availability slots for experiences."
        }
      },
      "required": [
        "id",
        "name",
        "bio",
        "location",
        "languages"
      ]
    },
    "Booking": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Booking",
      "type": "object",
      "description": "Represents a confirmed booking between a user and a local supporter.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Booking."
        },
        "userId": {
          "type": "string",
          "description": "ID of the user who made the booking."
        },
        "supporterId": {
          "type": "string",
          "description": "ID of the local supporter who was booked."
        },
        "supporterName": {
          "type": "string"
        },
        "userName": {
          "type": "string"
        },
        "experience": {
          "type": "string",
          "description": "The name of the experience that was booked."
        },
        "day": {
          "type": "string"
        },
        "time": {
          "type": "string"
        },
        "bookedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the booking was made."
        }
      },
      "required": [
        "id",
        "userId",
        "supporterId",
        "experience",
        "day",
        "time",
        "bookedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "google.com",
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile data. Path-based ownership is used. Only the user can read/write their own data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/trips/{tripId}",
        "definition": {
          "entityName": "Trip",
          "schema": {
            "$ref": "#/backend/entities/Trip"
          },
          "description": "Stores trip data associated with a user. Path-based ownership is enforced. Only the user can manage their trips.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "tripId",
              "description": "The unique identifier of the trip."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/trips/{tripId}/expenses/{expenseId}",
        "definition": {
          "entityName": "Expense",
          "schema": {
            "$ref": "#/backend/entities/Expense"
          },
          "description": "Stores expense data associated with a trip and user. Path-based ownership is enforced.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "tripId",
              "description": "The unique identifier of the trip."
            },
            {
              "name": "expenseId",
              "description": "The unique identifier of the expense."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}",
        "definition": {
          "entityName": "ItineraryItem",
          "schema": {
            "$ref": "#/backend/entities/ItineraryItem"
          },
          "description": "Stores itinerary items associated with a trip. Path-based ownership is enforced.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "tripId",
              "description": "The unique identifier of the trip."
            },
            {
              "name": "itineraryItemId",
              "description": "The unique identifier of the itinerary item."
            }
          ]
        }
      },
      {
        "path": "/local_businesses/{localBusinessId}",
        "definition": {
          "entityName": "LocalBusiness",
          "schema": {
            "$ref": "#/backend/entities/LocalBusiness"
          },
          "description": "Stores data for local businesses.",
          "params": [
            {
              "name": "localBusinessId",
              "description": "The unique identifier of the local business."
            }
          ]
        }
      },
      {
        "path": "/app-stats/{statId}",
        "definition": {
          "entityName": "AppStats",
          "schema": {
            "$ref": "#/backend/entities/AppStats"
          },
          "description": "Stores global application statistics. Publicly readable.",
          "params": [
            {
              "name": "statId",
              "description": "The unique identifier for the statistics document (e.g., 'live-stats')."
            }
          ]
        }
      },
      {
        "path": "/supporters/{supporterId}",
        "definition": {
          "entityName": "LocalSupporter",
          "schema": {
            "$ref": "#/backend/entities/LocalSupporter"
          },
          "description": "Stores profiles of local supporters. Publicly readable.",
          "params": [
            {
              "name": "supporterId",
              "description": "The unique identifier of the local supporter."
            }
          ]
        }
      },
      {
        "path": "/bookings/{bookingId}",
        "definition": {
          "entityName": "Booking",
          "schema": {
            "$ref": "#/backend/entities/Booking"
          },
          "description": "Stores confirmed bookings.",
          "rules": "allow list: if request.query.where.userId == request.auth.uid;\nallow get: if resource.data.userId == request.auth.uid || resource.data.supporterId == request.auth.uid;\nallow create: if request.resource.data.userId == request.auth.uid;",
          "params": [
            {
              "name": "bookingId",
              "description": "The unique identifier of the booking."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to be secure, scalable, and debuggable, adhering to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). It leverages denormalization for authorization and structural segregation for homogeneous security postures.\n\n**Authorization Independence:**\nAuthorization independence is achieved through path-based ownership for `User`, `Trip`, and `Expense` data. This eliminates the need for `get()` calls in security rules, enabling atomic operations. All data related to a user is stored under their `userId`, making ownership clear and enforceable directly in the path.\n\n**QAPs Support:**\nThe structure supports secure `list` operations (QAPs) by ensuring that each collection has a consistent security posture. For the `/bookings` collection, an explicit `allow list` rule has been defined to allow `list` operations only when the query explicitly filters for the user's own `userId`. This prevents users from listing all bookings in the system while still allowing them to fetch their own, which is a critical security pattern.\n\n**DBAC (Database-Based Access Control):**\nThis design uses the database to store roles. Since there are no roles defined, this design focuses on the 'request.auth.uid' for authorization, and ownership is determined based on the path. No custom claims are used.\n\n**Structure Overview:**\n- `/users/{userId}`: User profiles and related data (trips, expenses, itinerary items). This path enforces ownership.\n- `/local_businesses/{localBusinessId}`: Information about local businesses is stored globally. A separate collection could be created if business-owners need to update their entries, but this is not specified in the prompt. A separate service (not firestore rules) would handle authorization for that.\n- `/app-stats/{statId}`: A new collection to hold global, publicly readable application statistics like traveler counts.\n- `/supporters/{supporterId}`: A new collection to store profiles of local residents who volunteer to help travelers. This data is intended to be publicly readable to allow travelers to find support. Availability has been added to this entity to support the new booking flow.\n- `/bookings/{bookingId}`: A new collection to store confirmed bookings. The rules for this collection are now robust and explicitly defined, allowing reads for involved parties and secure, user-specific queries for lists."
  }
}

    