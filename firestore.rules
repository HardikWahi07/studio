/**
 * @fileoverview Firestore Security Rules for the TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data (profiles, trips, expenses, itinerary items).
 * Global application statistics and local supporter profiles are publicly readable.
 * Bookings have specific read/write rules to allow users and supporters to access relevant booking information.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /users/{userId}/trips/{tripId}: Stores trip data associated with a user.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense data for a trip.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items for a trip.
 * - /local_businesses/{localBusinessId}: Stores data for local businesses.
 * - /app-stats/{statId}: Stores global application statistics.
 * - /supporters/{supporterId}: Stores profiles of local supporters.
 * - /bookings/{bookingId}: Stores confirmed booking data.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the user's ID in the path.
 * - Global application statistics are publicly readable.
 * - Local supporter profiles are publicly readable.
 * - Listing all documents in user-owned collections is allowed only by the owner.
 * - Bookings can be listed only with a query for the user's own bookings.
 * - Only the user associated with a booking or the supporter involved can read a booking.
 * - Local Business updates not specified in prompt, only read for all users (public)
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the user can read/write their own data.
     * @path /users/{userId}
     * @allow (create) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can create their profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @allow (get) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can read their profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @allow (update) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can update their profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @deny (create) User otherUser cannot create a profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @deny (get) Other user cannot read profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure trip data associated with a user. Only the user can manage their trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can create a trip at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1.
     * @allow (get) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can read their trip at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1.
     * @allow (update) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can update their trip at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1.
     * @deny (create) User otherUser cannot create a trip at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1.
     * @deny (get) Other user cannot read trip at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/trips/{tripId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure expense data associated with a trip and user. Only the user can manage their expenses.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can create an expense at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/expenses/expense1.
     * @allow (get) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can read their expense at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/expenses/expense1.
     * @allow (update) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can update their expense at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/expenses/expense1.
     * @deny (create) User otherUser cannot create an expense at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/expenses/expense1.
     * @deny (get) Other user cannot read expense at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/expenses/expense1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure itinerary items associated with a trip. Only the user can manage their itinerary items.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can create an itinerary item at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/itinerary_items/item1.
     * @allow (get) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can read their itinerary item at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/itinerary_items/item1.
     * @allow (update) User cZ0nh1OUjCSw4JAPyqUWCMUqyIA3 can update their itinerary item at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/itinerary_items/item1.
     * @deny (create) User otherUser cannot create an itinerary item at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/itinerary_items/item1.
     * @deny (get) Other user cannot read itinerary item at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3/trips/trip1/itinerary_items/item1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Local businesses are publicly readable. Write permissions are not defined (assumed to be managed through a separate service).
     * @path /local_businesses/{localBusinessId}
     * @allow (get) Any user can read local business data.
     * @allow (list) Any user can list local business data.
     * @deny (create) No user can create local business.
     * @principle Allows public read access to local business information.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Application statistics are publicly readable. Write permissions are not defined.
     * @path /app-stats/{statId}
     * @allow (get) Any user can read application statistics.
     * @allow (list) Any user can list application statistics.
     * @deny (create) No user can create application statistics.
     * @principle Allows public read access to global application statistics.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Local supporter profiles are publicly readable. Write permissions are not defined.
     * @path /supporters/{supporterId}
     * @allow (get) Any user can read local supporter profiles.
     * @allow (list) Any user can list local supporter profiles.
     * @deny (create) No user can create local supporter.
     * @principle Allows public read access to local supporter profiles.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secure bookings. Users can only query bookings where their userId matches the authenticated user's ID.
     * Individual reads are allowed by either the user or the supporter involved in the booking.
     * @path /bookings/{bookingId}
     * @allow (list) User can list their bookings when the query explicitly filters for their userId.
     * @allow (get) User can read a booking if they are the user or the supporter involved in the booking.
     * @allow (create) User can create a booking with their userId.
     * @deny (list) User cannot list all bookings without filtering by their userId.
     * @principle Restricts access to bookings based on user and supporter involvement.
     */
    match /bookings/{bookingId} {
        function isOwner(userId) {
          return request.auth != null && request.auth.uid == userId;
        }

        allow get: if request.auth != null && (resource.data.userId == request.auth.uid || resource.data.supporterId == request.auth.uid);
        allow list: if request.auth != null && request.query.keys().hasOnly(["userId"]) && request.query.values().next().value() == request.auth.uid;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if false;
    }
  }
}