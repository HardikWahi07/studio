/**
 * @fileOverview Firestore Security Rules for the TripMind application.
 *
 * Core Philosophy:
 * This ruleset implements a strict user-ownership model for user-generated content (trips, expenses, itinerary items),
 * while allowing public read access to application statistics.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the authenticated user can read/write their own profile.
 * - /users/{userId}/trips/{tripId}: Stores trip data. Only the owning user can manage their trips.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense data for trips. Only the owning user can manage expenses.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items for trips. Only the owning user can manage itinerary items.
 * - /local_businesses/{localBusinessId}: Stores information about local businesses. Publicly readable.
 * - /app-stats/{statId}: Stores global application statistics. Publicly readable.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the owning user.
 * - Application statistics are publicly readable.
 * - Listing of local businesses is public to facilitate discovery.
 *
 * Denormalization for Authorization:
 *  - User ID is embedded in the path for trips, expenses, and itinerary items, enabling path-based authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own user document.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile with matching userId.
     * @allow (get, update, delete) - Authenticated user reads/updates/deletes their own profile.
     * @deny (create, get, update, delete) - Any other user attempts to access this profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Users collection is not listable.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) - Authenticated user creates a trip under their userId.
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their own trips.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this trip.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own expenses.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) - Authenticated user creates an expense under their trip.
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their own expenses.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this expense.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own itinerary items.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) - Authenticated user creates an itinerary item under their trip.
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their own itinerary items.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this itinerary item.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to local businesses.
     * @path /local_businesses/{localBusinessId}
     * @allow (get, list) - Any user can read local business data.
     * @deny (create, update, delete) - Only authorized service can modify local business data.
     * @principle Allows public read access to local business information.
     */
    match /local_businesses/{localBusinessId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation if businesses can manage their entries.
    }

    /**
     * @description Allows public read access to application statistics.
     * @path /app-stats/{statId}
     * @allow (get, list) - Any user can read application statistics.
     * @deny (create, update, delete) - Only authorized service can modify application statistics.
     * @principle Allows public read access to application statistics.
     */
    match /app-stats/{statId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Only admins can update.
    }
  }
}