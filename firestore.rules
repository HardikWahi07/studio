/**
 * @file Firestore Security Rules for TripMind
 * @description Enforces user-ownership and secure access while allowing public reads for specific collections.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model for personal data (users, trips, expenses, itinerary items) and provides public read access to data intended for general consumption (local businesses, app stats, local supporters). Bookings have custom rules to allow access to involved parties.
 * Data Structure:
 *   - User-specific data is nested under `/users/{userId}`, ensuring that only the user can access their own data.
 *   - Public data is stored in top-level collections like `/local_businesses`, `/app-stats`, and `/supporters`.
 *   - Bookings are stored in a top-level `/bookings` collection with specific rules.
 *
 * Key Security Decisions:
 *   - Users cannot list all users.
 *   - Public collections are read-only for clients, preventing unauthorized modifications.
 *   - Strict ownership is enforced for all user-related data, preventing cross-user data access.
 *
 * Denormalization for Authorization: The `bookings` collection denormalizes `userId` and `supporterId` directly on the booking document to allow for efficient authorization checks without additional reads.
 * Structural Segregation: Private user data is stored under the `/users/{userId}` path, while public data is stored in top-level collections, providing structural segregation for different security postures.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ”’ Utility: Check if signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // ðŸ”’ Utility: Check if this document belongs to the current user
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ðŸ”’ Utility: Check if the user is the existing owner of the document.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces that only the user can read, create, update, or delete their own user document.
     * @path /users/{userId}
     * @allow (get) User with UID 'user123' can read their own profile: `request.auth.uid == 'user123'`
     * @allow (create) User with UID 'user123' can create their own profile: `request.auth.uid == 'user123'`
     * @allow (update) User with UID 'user123' can update their own profile: `request.auth.uid == 'user123'`
     * @allow (delete) User with UID 'user123' can delete their own profile: `request.auth.uid == 'user123'`
     * @deny (get) User with UID 'user456' cannot read user 'user123' profile: `request.auth.uid != 'user123'`
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the user can manage their own trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (get) User with UID 'user123' can read trip 'trip789' under their profile: `request.auth.uid == 'user123'`
     * @allow (create) User with UID 'user123' can create a trip under their profile: `request.auth.uid == 'user123'`
     * @allow (update) User with UID 'user123' can update trip 'trip789' under their profile: `request.auth.uid == 'user123'`
     * @allow (delete) User with UID 'user123' can delete trip 'trip789' under their profile: `request.auth.uid == 'user123'`
     * @deny (get) User with UID 'user456' cannot read trip 'trip789' under user 'user123': `request.auth.uid != 'user123'`
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/trips/{tripId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the user can manage expenses associated with their trips.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (get) User with UID 'user123' can read expense 'expense456' under their trip 'trip789': `request.auth.uid == 'user123'`
     * @allow (create) User with UID 'user123' can create an expense under their trip 'trip789': `request.auth.uid == 'user123'`
     * @allow (update) User with UID 'user123' can update expense 'expense456' under their trip 'trip789': `request.auth.uid == 'user123'`
     * @allow (delete) User with UID 'user123' can delete expense 'expense456' under their trip 'trip789': `request.auth.uid == 'user123'`
     * @deny (get) User with UID 'user456' cannot read expense 'expense456' under user 'user123': `request.auth.uid != 'user123'`
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the user can manage itinerary items associated with their trips.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (get) User with UID 'user123' can read itinerary item 'item789' under their trip 'trip456': `request.auth.uid == 'user123'`
     * @allow (create) User with UID 'user123' can create an itinerary item under their trip 'trip456': `request.auth.uid == 'user123'`
     * @allow (update) User with UID 'user123' can update itinerary item 'item789' under their trip 'trip456': `request.auth.uid == 'user123'`
     * @allow (delete) User with UID 'user123' can delete itinerary item 'item789' under their trip 'trip456': `request.auth.uid == 'user123'`
     * @deny (get) User with UID 'user456' cannot read itinerary item 'item789' under user 'user123': `request.auth.uid != 'user123'`
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to local business data. Write operations are denied.
     * @path /local_businesses/{localBusinessId}
     * @allow (get) Any user can read local business data: `true`
     * @allow (list) Any user can list local business data: `true`
     * @deny (create) No user can create local business data: `false`
     * @deny (update) No user can update local business data: `false`
     * @deny (delete) No user can delete local business data: `false`
     * @principle Provides public read access while restricting write access.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to app stats. Write operations are denied.
     * @path /app-stats/{statId}
     * @allow (get) Any user can read app stats: `true`
     * @allow (list) Any user can list app stats: `true`
     * @deny (create) No user can create app stats: `false`
     * @deny (update) No user can update app stats: `false`
     * @deny (delete) No user can delete app stats: `false`
     * @principle Provides public read access while restricting write access.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to local supporter profiles. Write operations are denied.
     * @path /supporters/{supporterId}
     * @allow (get) Any user can read local supporter profiles: `true`
     * @allow (list) Any user can list local supporter profiles: `true`
     * @deny (create) No user can create local supporter profiles: `false`
     * @deny (update) No user can update local supporter profiles: `false`
     * @deny (delete) No user can delete local supporter profiles: `false`
     * @principle Provides public read access while restricting write access.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows controlled access to bookings. Users and supporters can read their own bookings. Only authenticated users can list bookings.
     * @path /bookings/{bookingId}
     * @allow (get) User with UID 'user123' can read booking 'booking456' if they are the user or supporter: `resource.data.userId == 'user123' || resource.data.supporterId == 'user123'`
     * @allow (list) Signed-in user can list bookings.
     * @allow (create) Signed-in user can create booking.
     * @deny (update) No user can update a booking directly: `false`
     * @deny (delete) No user can delete a booking: `false`
     * @principle Allows access to bookings for involved parties, restricts listing to signed-in users, and prevents direct modifications.
     */
    match /bookings/{bookingId} {
      // Allow read if user or supporter involved
      allow get: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.supporterId == request.auth.uid
      );

      // Allow listing for signed-in users (demo-friendly)
      allow list: if isSignedIn();

      // Allow creation by signed-in users
      allow create: if isSignedIn();

      // Block direct updates and deletions
      allow update: if false;
      allow delete: if false;
    }
  }
}