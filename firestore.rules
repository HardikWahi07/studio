/**
 * @fileoverview Firestore Security Rules for TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data (users, trips, expenses, itinerary items),
 * while allowing public read access to application statistics. Data validation is relaxed to allow for rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles and related data. Only the authenticated user can access their own profile.
 * - /users/{userId}/trips/{tripId}: Stores trip data. Only the owning user can access their trips.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense data. Only the owning user can access expenses.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary data. Only the owning user can access itinerary items.
 * - /local_businesses/{localBusinessId}: Stores local business data.
 * - /app-stats/{statId}: Stores global application statistics, publicly readable.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - The /app-stats collection is publicly readable but not writable from the client.
 * - Data validation is minimized to only enforce authorization constraints and essential relational integrity.
 * - All write operations require a verified Firebase Authentication user.
 *
 * Denormalization for Authorization:
 *  Ownership is enforced through path-based rules, avoiding the need for additional `get()` calls. The `userId` is
 *  implicitly denormalized into the path for all user-owned data.
 *
 * Structural Segregation:
 * Private user data is stored under /users/{userId}, while public application statistics are stored in the top-level
 * /app-stats collection. This allows for different security postures for each type of data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) Signed-in user creates their own profile with matching userId.
     * @allow (get,update,delete) Signed-in user accesses their own profile.
     * @deny  (create) User attempts to create a profile with a mismatched userId.
     * @deny  (get,list,update,delete) User attempts to access another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for trips. Only the authenticated user can manage their own trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) Signed-in user creates a trip under their userId.
     * @allow (get,update,delete) Signed-in user accesses their own trip.
     * @deny  (create) User attempts to create a trip under another user's userId.
     * @deny  (get,list,update,delete) User attempts to access another user's trip.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for expenses. Only the authenticated user can manage their own expenses.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) Signed-in user creates an expense under their userId and tripId.
     * @allow (get,update,delete) Signed-in user accesses their own expense.
     * @deny  (create) User attempts to create an expense under another user's userId or tripId.
     * @deny  (get,list,update,delete) User attempts to access another user's expense.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for itinerary items. Only the authenticated user can manage their own itinerary items.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) Signed-in user creates an itinerary item under their userId and tripId.
     * @allow (get,update,delete) Signed-in user accesses their own itinerary item.
     * @deny  (create) User attempts to create an itinerary item under another user's userId or tripId.
     * @deny  (get,list,update,delete) User attempts to access another user's itinerary item.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines access control for local businesses.
     * @path /local_businesses/{localBusinessId}
     * @allow (get,list) Any user can read local business data.
     * @deny (create,update,delete) No client-side writes are allowed. A separate service should manage this.
     * @principle Allows public read access.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Defines access control for application statistics. Publicly readable.
     * @path /app-stats/{statId}
     * @allow (get,list) Any user can read application statistics.
     * @deny (create,update,delete) No client-side writes are allowed.
     * @principle Allows public read access.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}