/**
 * @file TripMind Firestore Security Rules
 * @version Prototyping Mode - Relaxed schema validation, strict authorization.
 *
 * @description This ruleset provides basic security for the TripMind application.
 *   It enforces user-ownership for user profiles, trips, expenses and itinerary items.
 *   It allows public read access to local businesses, application statistics, and local supporters.
 *   It enforces role-based access on bookings.
 *
 * @dataStructure
 *   /users/{userId}: User profiles and associated data.
 *   /users/{userId}/trips/{tripId}: Trips planned by a user.
 *   /users/{userId}/trips/{tripId}/expenses/{expenseId}: Expenses for a specific trip.
 *   /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Itinerary items for a specific trip.
 *   /local_businesses/{localBusinessId}: Information about local businesses.
 *   /app-stats/{statId}: Application statistics.
 *   /supporters/{supporterId}: Local supporter profiles.
 *   /bookings/{bookingId}: Bookings between users and supporters.
 *
 * @keySecurityDecisions
 *   - User data (profiles, trips, expenses, itinerary items) is strictly controlled by the owning user.
 *   - Local business data, app statistics, and local supporter profiles are publicly readable.
 *   - Bookings can be read by either the user or the supporter involved.
 *   - Only the user that created a booking can create it
 *   - Listing of bookings is restricted to the user's own bookings.
 *   - No user listing is allowed for privacy.
 *   - All write operations require a verified user identity (request.auth != null).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data. Only the user can read/write their own data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     *   - auth.uid: 'user123'
     *   - request.resource.data.id: 'user123'
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.id: 'user123'
     * @deny (create) User with ID 'user123' cannot create a profile with a mismatched ID.
     *   - auth.uid: 'user123'
     *   - request.resource.data.id: 'user456'
     * @deny (get, update, delete) User with ID 'user456' cannot read, update, or delete user 'user123's profile.
     *   - auth.uid: 'user456'
     *   - resource.data.id: 'user123'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if request.auth != null && request.auth.uid == userId;
      allow list: if false;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Controls access to trip data associated with a user. Only the user can manage their trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) User with ID 'user123' can create a trip under their profile.
     *   - auth.uid: 'user123'
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their trips.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' cannot create a trip under user 'user123's profile.
     *   - auth.uid: 'user456'
     * @deny (get, update, delete) User with ID 'user456' cannot read, update, or delete user 'user123's trips.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId} {
      allow get: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Controls access to expense data associated with a trip and user.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) User with ID 'user123' can create an expense under their trip.
     *   - auth.uid: 'user123'
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their expenses.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' cannot create an expense under user 'user123's trip.
     *   - auth.uid: 'user456'
     * @deny (get, update, delete) User with ID 'user456' cannot read, update, or delete user 'user123's expenses.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      allow get: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Controls access to itinerary items associated with a trip.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) User with ID 'user123' can create an itinerary item under their trip.
     *   - auth.uid: 'user123'
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their itinerary items.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' cannot create an itinerary item under user 'user123's trip.
     *   - auth.uid: 'user456'
     * @deny (get, update, delete) User with ID 'user456' cannot read, update, or delete user 'user123's itinerary items.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      allow get: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Allows public read access to local business data.
     * @path /local_businesses/{localBusinessId}
     * @allow (get, list) Any user can read local business data.
     * @deny (create, update, delete) No one can create, update, or delete local business data without further authentication. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Allows public read access.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to application statistics.
     * @path /app-stats/{statId}
     * @allow (get, list) Any user can read application statistics.
     * @deny (create, update, delete) No one can create, update, or delete application statistics without further authentication. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Allows public read access.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to local supporter profiles.
     * @path /supporters/{supporterId}
     * @allow (get, list) Any user can read local supporter profiles.
     * @deny (create, update, delete) No one can create, update, or delete local supporter profiles without further authentication. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Allows public read access.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Controls access to booking data. Users can only query bookings where their userId matches the authenticated user's ID. Individual reads are allowed by either the user or the supporter involved in the booking.
     * @path /bookings/{bookingId}
     */
    match /bookings/{bookingId} {
          allow get: if request.auth != null;
          allow list: if request.auth != null;
          allow create: if request.auth != null;
          allow update: if request.auth != null;
          allow delete: if request.auth != null;
    }
  }
}