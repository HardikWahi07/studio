/**
 * @fileoverview Firestore Security Rules for TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data (profiles, trips, expenses, itinerary items),
 * while allowing public read access to application statistics and local supporter profiles. Bookings have specific
 * read/write rules based on user and supporter IDs.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data. Only the user can read/write their own data.
 * - /users/{userId}/trips/{tripId}: Stores trip data associated with a user. Only the user can manage their trips.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense data associated with a trip and user.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items associated with a trip.
 * - /local_businesses/{localBusinessId}: Stores data for local businesses (publicly readable).
 * - /app-stats/{statId}: Stores global application statistics (publicly readable).
 * - /supporters/{supporterId}: Stores profiles of local supporters (publicly readable).
 * - /bookings/{bookingId}: Stores confirmed bookings.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Public read access is granted to /app-stats and /supporters.
 * - Strict ownership is enforced for all data under the /users/{userId} path.
 * - Bookings are only listable with a query that restricts the results to the user's own bookings.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the existing resource's owner ID. Also validates that the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource.data.id == request.auth.uid;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can create their profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @deny (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot create a profile at /users/otherUserId.
     * @allow (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can read, update, or delete their profile at /users/cZ0nh1OUjCSw4JAPyqUWCMUqyIA3.
     * @deny (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot read, update, or delete another user's profile at /users/otherUserId.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for trips associated with a user.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can create a trip under their profile.
     * @deny (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot create a trip under another user's profile.
     * @allow (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can read, update, or delete their trips.
     * @deny (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot read, update, or delete another user's trips.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for expenses associated with a trip and user.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can create an expense under their trip.
     * @deny (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot create an expense under another user's trip.
     * @allow (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can read, update, or delete their expenses.
     * @deny (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot read, update, or delete another user's expenses.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for itinerary items associated with a trip.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can create an itinerary item under their trip.
     * @deny (create) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot create an itinerary item under another user's trip.
     * @allow (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' can read, update, or delete their itinerary items.
     * @deny (get, update, delete) User 'cZ0nh1OUjCSw4JAPyqUWCMUqyIA3' cannot read, update, or delete another user's itinerary items.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for local businesses.
     * @path /local_businesses/{localBusinessId}
     * @allow (get, list) Any user can read local business data.
     * @deny (create, update, delete) No one can create, update, or delete local business data through these rules.
     * @principle Allows public read access.
     */
    match /local_businesses/{localBusinessId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add logic for local business owners to manage their listings.
    }

    /**
     * @description Rules for application statistics.
     * @path /app-stats/{statId}
     * @allow (get, list) Any user can read application statistics.
     * @deny (create, update, delete) No one can create, update, or delete application statistics through these rules.
     * @principle Allows public read access.
     */
    match /app-stats/{statId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Prevent public modifications.
    }

    /**
     * @description Rules for local supporters.
     * @path /supporters/{supporterId}
     * @allow (get, list) Any user can read local supporter profiles.
     * @deny (create, update, delete) No one can create, update, or delete local supporter profiles through these rules.
     * @principle Allows public read access.
     */
    match /supporters/{supporterId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Prevent public modifications.
    }

    /**
     * @description Rules for bookings.
     * @path /bookings/{bookingId}
     * @allow (get) Either the user or the supporter involved in the booking can read it.
     * @allow (list) Users can only list bookings where their userId matches the authenticated user's ID.
     * @allow (create) A user can create a booking if their userId matches the authenticated user's ID.
     * @deny (update, delete) No one can update or delete bookings through these rules.
     */
    match /bookings/{bookingId} {
      allow get: if isSignedIn() && (resource.data.userId == request.auth.uid || resource.data.supporterId == request.auth.uid);
      allow list: if isSignedIn() && request.query.limit <= 10 && request.auth.uid == request.query.field;

      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if false; // Prevent any updates/deletes.
    }
  }
}