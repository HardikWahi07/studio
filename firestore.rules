/**
 * @fileoverview Firestore Security Rules for TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data (users, trips, expenses, itinerary items),
 * allowing users to manage their own information. Public data (app stats, local businesses, local supporters)
 * is readable by everyone. Bookings are readable by the user and supporter involved.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /users/{userId}/trips/{tripId}: Stores trip data associated with a user.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense data for a trip.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items for a trip.
 * - /local_businesses/{localBusinessId}: Stores information about local businesses.
 * - /app-stats/{statId}: Stores global application statistics.
 * - /supporters/{supporterId}: Stores profiles of local supporters.
 * - /bookings/{bookingId}: Stores confirmed bookings between users and local supporters.
 *
 * Key Security Decisions:
 * - User data is strictly private and only accessible to the owning user.
 * - App statistics and local business data are publicly readable.
 * - Listing of user documents is disallowed for privacy.
 * - Bookings are readable by the user and supporter involved, and listable by the user.
 *
 * Denormalization for Authorization:
 * - The /bookings/{bookingId} document contains both userId and supporterId to allow direct authorization
 *   without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @path N/A (Helper function)
     * @allow N/A
     * @deny N/A
     * @principle Authentication is required for private data access.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @path N/A (Helper function)
     * @allow N/A
     * @deny N/A
     * @principle Enforces user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID and the resource exists.
     * @path N/A (Helper function)
     * @allow N/A
     * @deny N/A
     * @principle Enforces user ownership and verifies resource existence before updates/deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource.data.id == userId;
    }

    /**
     * @description Defines rules for user profile data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile with data containing id: 'user123'.
     * @allow (get) - User with UID 'user123' can get their profile.
     * @allow (update) - User with UID 'user123' can update their profile.
     * @allow (delete) - User with UID 'user123' can delete their profile.
     * @deny (create) - User with UID 'user456' cannot create a profile for user with ID 'user123'.
     * @deny (get) - User with UID 'user456' cannot get the profile of user with ID 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines rules for trip data associated with a user.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) - User with UID 'user123' can create a trip under their profile.
     * @allow (get) - User with UID 'user123' can get a trip under their profile.
     * @allow (update) - User with UID 'user123' can update a trip under their profile.
     * @allow (delete) - User with UID 'user123' can delete a trip under their profile.
     * @deny (create) - User with UID 'user456' cannot create a trip under user 'user123''s profile.
     * @deny (get) - User with UID 'user456' cannot get a trip under user 'user123''s profile.
     * @principle Enforces path-based ownership; only the user can manage their trips.
     */
    match /users/{userId}/trips/{tripId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines rules for expense data associated with a trip and user.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) - User with UID 'user123' can create an expense for their trip.
     * @allow (get) - User with UID 'user123' can get an expense for their trip.
     * @allow (update) - User with UID 'user123' can update an expense for their trip.
     * @allow (delete) - User with UID 'user123' can delete an expense for their trip.
     * @deny (create) - User with UID 'user456' cannot create an expense for user 'user123''s trip.
     * @deny (get) - User with UID 'user456' cannot get an expense under user 'user123''s trip.
     * @principle Enforces path-based ownership for expenses.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines rules for itinerary items associated with a trip.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) - User with UID 'user123' can create an itinerary item for their trip.
     * @allow (get) - User with UID 'user123' can get an itinerary item for their trip.
     * @allow (update) - User with UID 'user123' can update an itinerary item for their trip.
     * @allow (delete) - User with UID 'user123' can delete an itinerary item for their trip.
     * @deny (create) - User with UID 'user456' cannot create an itinerary item for user 'user123''s trip.
     * @deny (get) - User with UID 'user456' cannot get an itinerary item under user 'user123''s trip.
     * @principle Enforces path-based ownership for itinerary items.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines rules for local business data.
     * @path /local_businesses/{localBusinessId}
     * @allow (get) - Any user can get local business data.
     * @allow (list) - Any user can list local businesses.
     * @deny (create) - No one can create a local business through direct client access.
     * @deny (update) - No one can update a local business through direct client access.
     * @deny (delete) - No one can delete a local business through direct client access.
     * @principle Allows public read access for local business information.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Defines rules for application statistics.
     * @path /app-stats/{statId}
     * @allow (get) - Any user can get application statistics.
     * @allow (list) - Any user can list application statistics.
     * @deny (create) - No one can create application statistics through direct client access.
     * @deny (update) - No one can update application statistics through direct client access.
     * @deny (delete) - No one can delete application statistics through direct client access.
     * @principle Allows public read access for application statistics.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Defines rules for local supporter profiles.
     * @path /supporters/{supporterId}
     * @allow (get) - Any user can get local supporter profiles.
     * @allow (list) - Any user can list local supporter profiles.
     * @deny (create) - No one can create a supporter through direct client access.
     * @deny (update) - No one can update a supporter through direct client access.
     * @deny (delete) - No one can delete a supporter through direct client access.
     * @principle Allows public read access for local supporter profiles.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Defines rules for bookings.
     * @path /bookings/{bookingId}
     * @allow (get) - User or supporter involved in the booking can read the booking.
     * @allow (list) - User can list bookings that belong to them.
     * @allow (create) - User can create a booking with their user ID.
     * @deny (update) - No one can update bookings through direct client access.
     * @deny (delete) - No one can delete bookings through direct client access.
     * @principle Enforces access control based on user and supporter involvement.
     */
    match /bookings/{bookingId} {
      allow get: if request.auth.uid == resource.data.userId || request.auth.uid == resource.data.supporterId;
      allow list: if isSignedIn() && request.auth.uid == request.query.userId;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // TODO: Add admin validation if needed.
      allow delete: if false; // TODO: Add admin validation if needed.
    }
  }
}