/**
 * @file Firebase Security Rules for TripMind Application
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data (users, trips, expenses, itinerary items),
 * while allowing public read access to application statistics and local supporter profiles.
 * Bookings have specific read and list rules to protect user privacy.
 *
 * Data Structure:
 * - /users/{userId}: Stores personal user data.
 * - /users/{userId}/trips/{tripId}: Stores trip planning data for individual users.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expenses related to a trip.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items related to a trip.
 * - /local_businesses/{localBusinessId}: Stores general data about local businesses (publicly readable).
 * - /app-stats/{statId}: Stores aggregate application statistics (publicly readable).
 * - /supporters/{supporterId}: Stores profiles of local supporters (publicly readable).
 * - /bookings/{bookingId}: Stores bookings, with access control based on user and supporter IDs.
 *
 * Key Security Decisions:
 * - User data is strictly owned by the user, accessible only via authenticated requests using their User ID.
 * - Application statistics and supporter profiles are publicly readable.
 * - Listing of collections containing personal data is restricted to the owner.
 * - Writes to local businesses and app stats are not covered, which may indicate an external mechanism (e.g., Cloud Functions) is used to manage those collections.
 *
 * Denormalization for Authorization:
 * - Path-based ownership avoids the need for `get()` calls to determine authorization for user-owned data.
 *
 * Structural Segregation:
 * - Publicly readable data (app stats, local supporters) is stored in separate top-level collections,
 *   allowing for simple and efficient public read rules without compromising user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profiles. Only the user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create a profile with id 'user123'.
     * @allow (get, update, delete) - User with UID 'user123' can read, update, or delete their own profile at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile with id 'user123'.
     * @deny (get, update, delete) - User with UID 'user456' cannot read, update, or delete the profile at /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures trip data associated with a user. Only the user can manage their trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) - User 'user123' can create a trip under /users/user123/trips/trip001.
     * @allow (get, update, delete) - User 'user123' can read, update, or delete the trip at /users/user123/trips/trip001.
     * @deny (create) - User 'user456' cannot create a trip under /users/user123/trips/trip001.
     * @deny (get, update, delete) - User 'user456' cannot read, update, or delete the trip at /users/user123/trips/trip001.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures expense data associated with a trip and user. Only the user can manage their expenses.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) - User 'user123' can create an expense under /users/user123/trips/trip001/expenses/expense001.
     * @allow (get, update, delete) - User 'user123' can read, update, or delete the expense at /users/user123/trips/trip001/expenses/expense001.
     * @deny (create) - User 'user456' cannot create an expense under /users/user123/trips/trip001/expenses/expense001.
     * @deny (get, update, delete) - User 'user456' cannot read, update, or delete the expense at /users/user123/trips/trip001/expenses/expense001.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures itinerary items associated with a trip. Only the user can manage their itinerary items.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) - User 'user123' can create an itinerary item under /users/user123/trips/trip001/itinerary_items/item001.
     * @allow (get, update, delete) - User 'user123' can read, update, or delete the itinerary item at /users/user123/trips/trip001/itinerary_items/item001.
     * @deny (create) - User 'user456' cannot create an itinerary item under /users/user123/trips/trip001/itinerary_items/item001.
     * @deny (get, update, delete) - User 'user456' cannot read, update, or delete the itinerary item at /users/user123/trips/trip001/itinerary_items/item001.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to local business data.
     * @path /local_businesses/{localBusinessId}
     * @allow (get, list) - Any user, even unauthenticated, can read local business data.
     * @deny (create, update, delete) - No direct write access; consider a Cloud Function for authorized updates.
     * @principle Allows public read access.
     */
    match /local_businesses/{localBusinessId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to application statistics.
     * @path /app-stats/{statId}
     * @allow (get, list) - Any user, even unauthenticated, can read app stats.
     * @deny (create, update, delete) - No direct write access; consider a Cloud Function for authorized updates.
     * @principle Allows public read access.
     */
    match /app-stats/{statId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to local supporter profiles.
     * @path /supporters/{supporterId}
     * @allow (get, list) - Any user, even unauthenticated, can read supporter profiles.
     * @deny (create, update, delete) - No direct write access; consider a Cloud Function for authorized updates.
     * @principle Allows public read access.
     */
    match /supporters/{supporterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Secures bookings, allowing reads by either the user or the supporter involved, and list operations filtered by the user's ID.
     * @path /bookings/{bookingId}
     * @allow (get) - User 'user123' can read a booking at /bookings/booking001 if resource.data.userId == 'user123' or resource.data.supporterId == 'user123'.
     * @allow (list) - User 'user123' can list bookings where request.query.where("userId", "==", "user123") is true.
     * @allow (create) - User 'user123' can create a booking where request.resource.data.userId == 'user123'.
     * @deny (get) - User 'user456' cannot read a booking at /bookings/booking001 where resource.data.userId != 'user456' and resource.data.supporterId != 'user456'.
     * @deny (list) - User 'user123' cannot list bookings without the query filter request.query.where("userId", "==", "user123").
     * @deny (create) - User 'user456' cannot create a booking where request.resource.data.userId != 'user456'.
     * @principle Enforces role-based access control for bookings.
     */
    match /bookings/{bookingId} {
      allow get: if request.auth != null && (resource.data.userId == request.auth.uid || resource.data.supporterId == request.auth.uid);
      allow list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}