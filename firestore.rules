/**
 * @fileoverview Firestore Security Rules for TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, trips, expenses and itinerary items. Only the authenticated user can access their own data. Public read access is granted to local business information, but creation/modification is not supported in this prototype.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /users/{userId}/trips/{tripId}: Stores trip data associated with a user.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense data associated with a trip and user.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items associated with a trip.
 * - /local_businesses/{localBusinessId}: Stores data for local businesses.
 *
 * Key Security Decisions:
 * - User data is strictly private and only accessible to the owning user.
 * - Listing of user documents (/users) is disallowed.
 * - Local business data is publicly readable.
 * - Write access to local business data is disallowed in this prototype due to lack of owner/role definition.
 *
 * Denormalization for Authorization:
 * The 'userId' is embedded within the paths for trips, expenses, and itinerary items to enable path-based authorization. This avoids the need for expensive 'get()' calls to determine ownership.
 *
 * Structural Segregation:
 * User-specific data (trips, expenses, itinerary items) is stored under the /users/{userId} path, while public data (local businesses) is stored in a top-level collection. This structural segregation simplifies security rules and optimizes query performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles. Only the user can read/write their own data.
     * @path /users/{userId}
     * @allow (create) - User with auth UID 'user_abc' can create their own profile at /users/user_abc.
     * @allow (get) - User with auth UID 'user_abc' can get their own profile at /users/user_abc.
     * @allow (update) - User with auth UID 'user_abc' can update their own profile at /users/user_abc.
     * @allow (delete) - User with auth UID 'user_abc' can delete their own profile at /users/user_abc.
     * @deny (create) - User with auth UID 'user_xyz' cannot create a profile at /users/user_abc.
     * @deny (get) - User with auth UID 'user_xyz' cannot get the profile at /users/user_abc.
     * @deny (update) - User with auth UID 'user_xyz' cannot update the profile at /users/user_abc.
     * @deny (delete) - User with auth UID 'user_xyz' cannot delete the profile at /users/user_abc.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Allow the user to read their own document
      allow get: if isSignedIn() && isOwner(userId);
      // Allow the user to create their own document if the userId matches their auth UID
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      // Allow the user to update their own document
      allow update: if isSignedIn() && isOwner(userId) && resource != null && request.resource.data.id == resource.data.id;
      // Allow the user to delete their own document if it exists
      allow delete: if isSignedIn() && isExistingOwner(userId);
      // Prevent listing of all user documents
      allow list: if false;
    }

    /**
     * @description Enforces user-ownership for trips. Only the user can manage their own trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) - User with auth UID 'user_abc' can create a trip at /users/user_abc/trips/trip_123.
     * @allow (get) - User with auth UID 'user_abc' can get the trip at /users/user_abc/trips/trip_123.
     * @allow (update) - User with auth UID 'user_abc' can update the trip at /users/user_abc/trips/trip_123.
     * @allow (delete) - User with auth UID 'user_abc' can delete the trip at /users/user_abc/trips/trip_123.
     * @deny (create) - User with auth UID 'user_xyz' cannot create a trip at /users/user_abc/trips/trip_123.
     * @deny (get) - User with auth UID 'user_xyz' cannot get the trip at /users/user_abc/trips/trip_123.
     * @deny (update) - User with auth UID 'user_xyz' cannot update the trip at /users/user_abc/trips/trip_123.
     * @deny (delete) - User with auth UID 'user_xyz' cannot delete the trip at /users/user_abc/trips/trip_123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId} {
      // Allow the user to read their own trip
      allow get: if isSignedIn() && isOwner(userId);
      // Allow the user to create a trip
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      // Allow the user to update their own trip if it exists
      allow update: if isSignedIn() && isOwner(userId) && resource != null && request.resource.data.userId == resource.data.userId;
      // Allow the user to delete their own trip if it exists
      allow delete: if isSignedIn() && isExistingOwner(userId);
      // Allow the owner to list their trips
      allow list: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces user-ownership for expenses. Only the user can manage their own expenses.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) - User with auth UID 'user_abc' can create an expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @allow (get) - User with auth UID 'user_abc' can get the expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @allow (update) - User with auth UID 'user_abc' can update the expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @allow (delete) - User with auth UID 'user_abc' can delete the expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @deny (create) - User with auth UID 'user_xyz' cannot create an expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @deny (get) - User with auth UID 'user_xyz' cannot get the expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @deny (update) - User with auth UID 'user_xyz' cannot update the expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @deny (delete) - User with auth UID 'user_xyz' cannot delete the expense at /users/user_abc/trips/trip_123/expenses/expense_456.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      // Allow the user to read their own expense
      allow get: if isSignedIn() && isOwner(userId);
      // Allow the user to create an expense
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      // Allow the user to update their own expense if it exists
      allow update: if isSignedIn() && isOwner(userId) && resource != null && request.resource.data.userId == resource.data.userId;
      // Allow the user to delete their own expense if it exists
      allow delete: if isSignedIn() && isExistingOwner(userId);
      // Allow the owner to list their expenses
      allow list: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces user-ownership for itinerary items. Only the user can manage their own itinerary items.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) - User with auth UID 'user_abc' can create an itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @allow (get) - User with auth UID 'user_abc' can get the itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @allow (update) - User with auth UID 'user_abc' can update the itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @allow (delete) - User with auth UID 'user_abc' can delete the itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @deny (create) - User with auth UID 'user_xyz' cannot create an itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @deny (get) - User with auth UID 'user_xyz' cannot get the itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @deny (update) - User with auth UID 'user_xyz' cannot update the itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @deny (delete) - User with auth UID 'user_xyz' cannot delete the itinerary item at /users/user_abc/trips/trip_123/itinerary_items/item_789.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      // Allow the user to read their own itinerary item
      allow get: if isSignedIn() && isOwner(userId);
      // Allow the user to create an itinerary item
      allow create: if isSignedIn() && isOwner(userId); // No userId check in request.resource.data
      // Allow the user to update their own itinerary item if it exists
      allow update: if isSignedIn() && isOwner(userId) && resource != null;  // No userId check in request.resource.data
      // Allow the user to delete their own itinerary item if it exists
      allow delete: if isSignedIn() && isExistingOwner(userId);
      // Allow the owner to list their itinerary items
      allow list: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows public read access to local business data.  Write access is disallowed in this prototype.
     * @path /local_businesses/{localBusinessId}
     * @allow (get) - Any user can get a local business.
     * @allow (list) - Any user can list local businesses.
     * @deny (create) - No one can create a local business in this prototype.
     * @deny (update) - No one can update a local business in this prototype.
     * @deny (delete) - No one can delete a local business in this prototype.
     * @principle Allows public read access.
     */
    match /local_businesses/{localBusinessId} {
      // Allow public read access to local business data
      allow get, list: if true;
      // Disallow write access to local business data in this prototype
      allow create, update, delete: if false;
    }
  }

  // Helper function to determine if the user is signed in
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner of the document and the document exists
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}