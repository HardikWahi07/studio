/**
 * @fileoverview Firestore Security Rules for TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data (profiles, trips, expenses, itinerary items),
 * while allowing public read access to application statistics and local supporter profiles. Bookings can be accessed by either the user or the supporter.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/trips/{tripId}: Stores trip data for each user.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expenses related to trips.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items for trips.
 * - /local_businesses/{localBusinessId}: Stores information about local businesses.
 * - /app-stats/{statId}: Stores global application statistics.
 * - /supporters/{supporterId}: Stores profiles of local supporters.
 * - /bookings/{bookingId}: Stores booking information, can be accessed by either the user or supporter.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the user's ID in the path.
 * - Listing of documents is generally allowed for user-owned subcollections.
 * - App statistics and supporter profiles are publicly readable.
 * - Bookings can be read by users and supporters.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles. Only the user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete) if the user's auth UID matches the userId in the path.
     * @deny (create, update, delete) if the user's auth UID does not match the userId in the path.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Enforces user-ownership for trips. Only the user can manage their own trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create, update, delete) if the user's auth UID matches the userId in the path.
     * @deny (create, update, delete) if the user's auth UID does not match the userId in the path.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Enforces user-ownership for expenses. Only the user can manage expenses for their trips.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create, update, delete) if the user's auth UID matches the userId in the path.
     * @deny (create, update, delete) if the user's auth UID does not match the userId in the path.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Enforces user-ownership for itinerary items. Only the user can manage itinerary items for their trips.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create, update, delete) if the user's auth UID matches the userId in the path.
     * @deny (create, update, delete) if the user's auth UID does not match the userId in the path.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to local business data.
     * @path /local_businesses/{localBusinessId}
     * @allow (get, list) to all users.
     * @deny (create, update, delete) to all users.
     * @principle Allows public reads and restricts writes.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to application statistics.
     * @path /app-stats/{statId}
     * @allow (get, list) to all users.
     * @deny (create, update, delete) to all users.
     * @principle Allows public reads and restricts writes.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to local supporter profiles.
     * @path /supporters/{supporterId}
     * @allow (get, list) to all users.
     * @deny (create, update, delete) to all users.
     * @principle Allows public reads and restricts writes.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows users and supporters to access booking data.
     * @path /bookings/{bookingId}
     * @allow (get) to the user or supporter associated with the booking.
     * @allow (list) to users who query for their own bookings.
     * @deny (create, update, delete) to all users.
     * @principle Restricts access to bookings based on user and supporter IDs.
     */
    match /bookings/{bookingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && (resource.data.userId == request.auth.uid || resource.data.supporterId == request.auth.uid);
      allow list: if isSignedIn() && request.query.where("userId", "==", request.auth.uid);

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (request.resource.data.userId == request.auth.uid || request.resource.data.supporterId == request.auth.uid);
      allow delete: if false;
    }
  }
}