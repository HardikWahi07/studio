/**
 * @fileoverview Firestore Security Rules for TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data (profiles, trips, expenses, itinerary items),
 * while allowing public read access to local business, supporter, and app statistics data.
 * Bookings are secured such that only the user or supporter associated with a booking can access it.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, trips, expenses, and itinerary items, accessible only by the user.
 * - /local_businesses/{localBusinessId}: Publicly readable data for local businesses.
 * - /app-stats/{statId}: Publicly readable application statistics.
 * - /supporters/{supporterId}: Publicly readable profiles of local supporters.
 * - /bookings/{bookingId}: Bookings, accessible only by the user or supporter involved.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the user-ownership model.
 * - Public collections (/local_businesses, /app-stats, /supporters) allow open reads.
 * - Listing of bookings is restricted to the user's own bookings.
 * - The rules DO NOT enforce data validation beyond authorization and relational integrity to allow for prototyping.
 *
 * Denormalization for Authorization:
 * - The rules assume denormalization of 'userId' on Trip and Expense documents to avoid costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profile data based on user ID.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     * @allow (get) User with ID 'user123' can read their profile.
     * @allow (update) User with ID 'user123' can update their profile.
     * @allow (delete) User with ID 'user123' can delete their profile.
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants access to trip data based on user and trip IDs.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) User with ID 'user123' can create a trip with ID 'trip456' under their profile.
     * @allow (get) User with ID 'user123' can read the trip with ID 'trip456' under their profile.
     * @allow (update) User with ID 'user123' can update the trip with ID 'trip456' under their profile.
     * @allow (delete) User with ID 'user123' can delete the trip with ID 'trip456' under their profile.
     * @deny (create) User with ID 'user456' cannot create a trip with ID 'trip456' under user 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing trips is generally not allowed for security reasons
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants access to expense data based on user, trip, and expense IDs.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) User with ID 'user123' can create an expense with ID 'expense789' under trip 'trip456'.
     * @allow (get) User with ID 'user123' can read the expense with ID 'expense789' under trip 'trip456'.
     * @allow (update) User with ID 'user123' can update the expense with ID 'expense789' under trip 'trip456'.
     * @allow (delete) User with ID 'user123' can delete the expense with ID 'expense789' under trip 'trip456'.
     * @deny (create) User with ID 'user456' cannot create an expense with ID 'expense789' under user 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing expenses is generally not allowed for security reasons
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants access to itinerary item data based on user, trip, and item IDs.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) User with ID 'user123' can create an itinerary item with ID 'item101' under trip 'trip456'.
     * @allow (get) User with ID 'user123' can read the itinerary item with ID 'item101' under trip 'trip456'.
     * @allow (update) User with ID 'user123' can update the itinerary item with ID 'item101' under trip 'trip456'.
     * @allow (delete) User with ID 'user123' can delete the itinerary item with ID 'item101' under trip 'trip456'.
     * @deny (create) User with ID 'user456' cannot create an itinerary item with ID 'item101' under user 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing itinerary items is generally not allowed for security reasons
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows public read access to local business data.
     * @path /local_businesses/{localBusinessId}
     * @allow (get) Any user can read local business data.
     * @allow (list) Any user can list local businesses.
     * @deny (create) No one can create local business documents through the rules.
     * @deny (update) No one can update local business documents through the rules.
     * @deny (delete) No one can delete local business documents through the rules.
     * @principle Allows public read access.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to application statistics.
     * @path /app-stats/{statId}
     * @allow (get) Any user can read application statistics.
     * @allow (list) Any user can list application statistics.
     * @deny (create) No one can create application statistics through the rules.
     * @deny (update) No one can update application statistics through the rules.
     * @deny (delete) No one can delete application statistics through the rules.
     * @principle Allows public read access.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to local supporter profiles.
     * @path /supporters/{supporterId}
     * @allow (get) Any user can read local supporter profiles.
     * @allow (list) Any user can list local supporter profiles.
     * @deny (create) No one can create local supporter profiles through the rules.
     * @deny (update) No one can update local supporter profiles through the rules.
     * @deny (delete) No one can delete local supporter profiles through the rules.
     * @principle Allows public read access.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to bookings based on user and supporter IDs.
     * @path /bookings/{bookingId}
     * @allow (get) User or supporter associated with the booking can read it.
     * @allow (list) User can list bookings where their userId matches the authenticated user's ID.
     * @allow (create) User can create bookings where their userId matches the authenticated user's ID.
     * @deny (update) No one can update the bookings through the rules.
     * @deny (delete) No one can delete the bookings through the rules.
     * @principle Enforces access based on user and supporter association.
     */
    match /bookings/{bookingId} {
        allow get: if isSignedIn() && (resource.data.userId == request.auth.uid || resource.data.supporterId == request.auth.uid);
        allow list: if isSignedIn() && exists(/databases/$(database)/documents/bookings/$(bookingId)) && resource.data.userId == request.auth.uid;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if false;
    }

  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isSignedIn() && request.auth.uid == userId && exists(/databases/$(database)/documents/users/$(userId));
  }
}