/**
 * @fileoverview Firestore Security Rules for the TripMind application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data (profiles, trips, expenses, itinerary items).
 * Global data (local businesses, app stats, local supporters) is publicly readable but not writable via these rules.
 * The booking collection enforces that only the user or supporter involved in a booking can access it.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/trips/{tripId}: Stores trip information for a specific user.
 * - /users/{userId}/trips/{tripId}/expenses/{expenseId}: Stores expense information for a specific trip.
 * - /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}: Stores itinerary items for a specific trip.
 * - /local_businesses/{localBusinessId}: Stores information about local businesses.
 * - /app-stats/{statId}: Stores global application statistics.
 * - /supporters/{supporterId}: Stores profiles of local supporters.
 * - /bookings/{bookingId}: Stores booking information, accessible only to the user and supporter involved.
 *
 * Key Security Decisions:
 * - Users can only access their own profile and related data (trips, expenses, itinerary items).
 * - Listing of user documents is disallowed.
 * - Local businesses, app stats, and local supporters are publicly readable.
 * - Bookings are accessible to the user and supporter involved.
 *
 * Denormalization for Authorization:
 *  - The bookings collection contains both `userId` and `supporterId` so that it is possible to directly verify access without additional reads.
 *
 * Structural Segregation:
 *  - Data is segregated by access type. User specific data is stored under the /users collection. App Statistics and LocalSupporters are stored in the top level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profile data. Only the user can read/write their own data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create their profile.
     *   request.auth.uid == 'user_abc' && request.resource.data.id == 'user_abc'
     * @allow (get, update, delete) - User with UID 'user_abc' can get, update, and delete their profile.
     *   request.auth.uid == 'user_abc' && resource.data.id == 'user_abc'
     * @deny (create) - User with UID 'user_abc' cannot create a profile for 'user_xyz'.
     *   request.auth.uid == 'user_abc' && request.resource.data.id == 'user_xyz'
     * @deny (get, update, delete) - User with UID 'user_abc' cannot get, update, and delete the profile of 'user_xyz'.
     *   request.auth.uid == 'user_abc' && resource.data.id == 'user_xyz'
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if request.auth.uid == userId && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects trip data associated with a user. Only the user can manage their trips.
     * @path /users/{userId}/trips/{tripId}
     * @allow (create) - User with UID 'user_abc' can create a trip under their profile.
     *   request.auth.uid == 'user_abc'
     * @allow (get, update, delete) - User with UID 'user_abc' can get, update, and delete a trip under their profile.
     *   request.auth.uid == 'user_abc'
     * @deny (create) - User with UID 'user_abc' cannot create a trip under the profile of 'user_xyz'.
     *   request.auth.uid == 'user_xyz'
     * @deny (get, update, delete) - User with UID 'user_abc' cannot get, update, and delete a trip under the profile of 'user_xyz'.
     *   request.auth.uid == 'user_xyz'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects expense data associated with a trip and user. Path-based ownership is enforced.
     * @path /users/{userId}/trips/{tripId}/expenses/{expenseId}
     * @allow (create) - User with UID 'user_abc' can create an expense under their trip.
     *   request.auth.uid == 'user_abc'
     * @allow (get, update, delete) - User with UID 'user_abc' can get, update, and delete an expense under their trip.
     *   request.auth.uid == 'user_abc'
     * @deny (create) - User with UID 'user_abc' cannot create an expense under the trip of 'user_xyz'.
     *   request.auth.uid == 'user_xyz'
     * @deny (get, update, delete) - User with UID 'user_abc' cannot get, update, and delete an expense under the trip of 'user_xyz'.
     *   request.auth.uid == 'user_xyz'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects itinerary items associated with a trip. Path-based ownership is enforced.
     * @path /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId}
     * @allow (create) - User with UID 'user_abc' can create an itinerary item under their trip.
     *   request.auth.uid == 'user_abc'
     * @allow (get, update, delete) - User with UID 'user_abc' can get, update, and delete an itinerary item under their trip.
     *   request.auth.uid == 'user_abc'
     * @deny (create) - User with UID 'user_abc' cannot create an itinerary item under the trip of 'user_xyz'.
     *   request.auth.uid == 'user_xyz'
     * @deny (get, update, delete) - User with UID 'user_abc' cannot get, update, and delete an itinerary item under the trip of 'user_xyz'.
     *   request.auth.uid == 'user_xyz'
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/trips/{tripId}/itinerary_items/{itineraryItemId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Stores data for local businesses. Publicly readable.
     * @path /local_businesses/{localBusinessId}
     * @allow (get, list) - Any user can read local business data.
     * @deny (create, update, delete) - No user can create, update, or delete local business data.
     * @principle Allows public read access, restricts write access.
     */
    match /local_businesses/{localBusinessId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores global application statistics. Publicly readable.
     * @path /app-stats/{statId}
     * @allow (get, list) - Any user can read application statistics.
     * @deny (create, update, delete) - No user can create, update, or delete application statistics.
     * @principle Allows public read access, restricts write access.
     */
    match /app-stats/{statId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores profiles of local supporters. Publicly readable.
     * @path /supporters/{supporterId}
     * @allow (get, list) - Any user can read local supporter profiles.
     * @deny (create, update, delete) - No user can create, update, or delete local supporter profiles.
     * @principle Allows public read access, restricts write access.
     */
    match /supporters/{supporterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores confirmed bookings. Users can only query bookings where their userId matches the authenticated user's ID. Individual reads are allowed by either the user or the supporter involved in the booking.
     * @path /bookings/{bookingId}
     * @allow (list) - User can list bookings only when the query filters by their userId.
     *   request.auth.uid == request.query.where.userId
     * @allow (get) - User or Supporter involved in the booking can read it.
     *   request.auth.uid == resource.data.userId || request.auth.uid == resource.data.supporterId
     * @allow (create) - User can create a booking when their userId matches.
     *   request.auth.uid == request.resource.data.userId
     * @deny (update, delete) - Update and delete are not supported
     * @principle Allows reads for involved parties and secure, user-specific queries for lists.
     */
    match /bookings/{bookingId} {
      function isBookedUserOrSupporter() {
        return request.auth.uid == resource.data.userId || request.auth.uid == resource.data.supporterId;
      }
      allow get: if isBookedUserOrSupporter();
      allow list: if request.auth.uid != null && request.query.where("userId", "==", request.auth.uid).size() > 0;
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if false;
      allow delete: if false;
    }
  }
}